# Импорт общих ящиков из файла

## Описание

Функция импорта общих ящиков позволяет массово создавать общие почтовые ящики в Яндекс 360 из CSV файла.

## Формат файла shared.csv

Файл должен иметь следующую структуру:

- **Разделитель**: точка с запятой (`;`)
- **Кодировка**: UTF-8
- **Обязательные колонки**: `email;name;description`

### Структура колонок:

1. **email** - адрес электронной почты или алиас
   - Допустимые форматы:
     - `alias` - только алиас (будет добавлен домен из настроек)
     - `alias@domain.com` - полный адрес электронной почты
   - Требования к алиасу:
     - Должен начинаться и заканчиваться буквой или цифрой
     - Может содержать точки (`.`), дефисы (`-`) и подчеркивания (`_`)
     - Не может содержать последовательные специальные символы

2. **name** - имя общего ящика (обязательное поле)
   - Отображаемое название ящика

3. **description** - описание ящика (необязательное поле)
   - Дополнительная информация о назначении ящика

### Комментарии

Строки, начинающиеся с символа `#`, пропускаются при импорте.

## Пример файла shared.csv

```csv
email;name;description
support;Support Team;Общий ящик службы поддержки
info;Information;Информационный ящик для общих запросов
sales@company.com;Sales Department;Ящик отдела продаж
# hr;Human Resources;Этот ящик будет пропущен при импорте
```

## Валидация данных

Перед импортом выполняются следующие проверки:

1. **Проверка формата email**
   - Валидация формата алиаса и домена
   - Проверка на допустимые символы

2. **Проверка уникальности email адресов**
   - Поиск дубликатов в файле
   - Email адреса проверяются без учета регистра

3. **Проверка обязательных полей**
   - Поле `name` не может быть пустым

4. **Проверка структуры файла**
   - Наличие заголовков
   - Правильное количество колонок в каждой строке

## Обработка ошибок

### При обнаружении ошибок валидации:

- Импорт **НЕ выполняется**
- Выводится список всех найденных ошибок с указанием номеров строк
- Необходимо исправить ошибки и повторить импорт

### Пример вывода ошибок:

```
----------------------------------------------------------------------------------------------------
Обнаружены ошибки в файле:
----------------------------------------------------------------------------------------------------
  Строка 3: Некорректный email "test@": Домен email адреса не может быть пустым
  Строка 5: Дублирующийся email "support" (уже встречался в строке 2)
  Строка 7: Поле "name" не может быть пустым для email "sales"
----------------------------------------------------------------------------------------------------
Импорт прерван. Исправьте ошибки и попробуйте снова.
----------------------------------------------------------------------------------------------------
```

## Конфигурация

### Файл .env

Имя файла с данными общих ящиков можно настроить в файле `.env`:

```env
# Файл с данными общих почтовых ящиков
SHARED_MAILBOXES_FILE=shared.csv
```

Если параметр не указан, используется значение по умолчанию: `shared.csv`

Вы можете указать другое имя файла:
```env
SHARED_MAILBOXES_FILE=my_mailboxes.csv
```

## Использование

### Через меню программы:

1. Запустите программу
2. Выберите пункт меню "7. Импортировать общие ящики из файла"
3. Введите путь к файлу (по умолчанию используется значение из `SHARED_MAILBOXES_FILE` в `.env`)
4. Подтвердите импорт

### Программный вызов:

```python
# Импорт с файлом по умолчанию (shared.csv)
import_shared_mailboxes_from_file(settings)

# Импорт из конкретного файла
import_shared_mailboxes_from_file(settings, "my_mailboxes.csv")
```

## Процесс импорта

Импорт выполняется в 2 фазы:

### Фаза 1: Чтение и валидация файла
- Чтение файла
- Валидация всех данных
- Проверка на дубликаты
- При наличии ошибок - импорт прерывается

### Фаза 2: Создание общих ящиков
- Последовательное создание каждого ящика через API
- Логирование результатов для каждого ящика
- Подсчет успешных и неудачных операций
- Вывод итоговой статистики

## Результаты импорта

После завершения импорта выводится статистика:

```
----------------------------------------------------------------------------------------------------
Импорт завершен
----------------------------------------------------------------------------------------------------
Всего обработано: 4
Успешно создано: 3
Ошибок: 1
----------------------------------------------------------------------------------------------------
```

## API метод

Функция использует API метод Yandex 360:

```
PUT https://api360.yandex.net/admin/v1/org/{orgId}/mailboxes/shared
```

**Тело запроса:**
```json
{
  "email": "support@company.com",
  "name": "Support Team",
  "description": "Общий ящик службы поддержки"
}
```

## Обработка ошибок

### Специальные ошибки

Функция распознает и обрабатывает следующие специфические ошибки:

#### 1. Email адрес уже занят другим пользователем (`passport_email_taken`)

Если email адрес уже используется в организации другим пользователем (не общим ящиком):

**Ответ API:**
```json
{
    "code": 6,
    "message": "passport_email_taken"
}
```

**Поведение:**
- ✅ Выводится понятное сообщение: "Email адрес уже используется в организации (не общим ящиком)"
- ✅ Повторные попытки **НЕ делаются** (бесполезны)
- ✅ Импорт продолжается для следующих ящиков

**Пример в логах:**
```
ERROR: Ошибка: Email адрес 'support@company.ru' уже используется в организации (не общим ящиком).
ERROR: Общий ящик 'support@company.ru' не может быть создан - Email адрес занят (не общим ящиком).
```

**Решение:** Используйте другой email адрес для общего ящика.

#### 2. Общий ящик уже существует (`resource_already_exists`)

Если общий ящик с таким email адресом уже существует в организации:

**Ответ API:**
```json
{
    "message": "resource_already_exists"
}
```

**Поведение:**
- ✅ Выводится сообщение: "Общий ящик уже существует в организации"
- ✅ Повторные попытки **НЕ делаются** (бесполезны)
- ✅ Импорт продолжается для следующих ящиков

**Пример в логах:**
```
ERROR: Ошибка: Общий ящик 'support@company.ru' уже существует в организации.
ERROR: Общий ящик 'support@company.ru' не может быть создан - Общий ящик уже существует в организации.
```

**Решение:** Проверьте список существующих общих ящиков в консоли Yandex 360 или используйте другой email адрес.

#### 3. Неверный токен (`Unauthorized`)

Если OAuth токен недействителен или истек:

**Ответ API:**
```json
{
    "message": "Unauthorized"
}
```

**Поведение:**
- ✅ Выводится сообщение: "Неверный токен"
- ✅ Повторные попытки **НЕ делаются**
- ✅ Импорт продолжается для следующих ящиков (но все будут с ошибкой)

**Пример в логах:**
```
ERROR: Ошибка: Неверный токен.
ERROR: Общий ящик 'support@company.ru' не может быть создан - Неверный токен.
```

**Решение:** 
1. Проверьте, не истек ли срок действия токена
2. Сгенерируйте новый OAuth токен на https://oauth.yandex.ru
3. Обновите `OAUTH_TOKEN` в файле `.env`

#### 4. Недостаточно прав (`No required scope`)

Если у токена нет необходимых прав для создания общих ящиков:

**Ответ API:**
```json
{
    "message": "No required scope"
}
```

**Поведение:**
- ✅ Выводится детальное сообщение с инструкцией
- ✅ Указываются необходимые права
- ✅ Повторные попытки **НЕ делаются**
- ✅ Импорт продолжается для следующих ящиков (но все будут с ошибкой)

**Пример в логах:**
```
ERROR: Ошибка: Не хватает прав для создания общего ящика.
ERROR: Добавьте права:
ERROR:  - ya360_admin:mail_write_shared_mailbox_inventory
ERROR: в консоли управления доступом к API 360 (oauth.yandex.ru).
ERROR: Общий ящик 'support@company.ru' не может быть создан - Не хватает прав для создания общего ящика.
```

**Решение:**
1. Перейдите на https://oauth.yandex.ru
2. Откройте настройки вашего приложения
3. Добавьте необходимое право:
   - `ya360_admin:mail_write_shared_mailbox_inventory`
4. Сгенерируйте новый токен
5. Обновите `OAUTH_TOKEN` в файле `.env`

#### 5. Неверные данные в запросе (`invalid_data`)

Если данные в запросе не соответствуют требованиям API (например, неверный формат email или домен):

**Ответ API:**
```json
{
    "message": "invalid_data"
}
```

**Возможные причины:**
- Email адрес указан не в основном (по умолчанию) домене организации
- Параметр `EMAIL_DOMAIN` в `.env` указан неверно или отсутствует
- Неверный формат email адреса
- Отсутствует обязательное поле `name`

**Поведение:**
- ✅ Выводится детальное сообщение с объяснением проблемы
- ✅ Указывается текущее значение `EMAIL_DOMAIN`
- ✅ Повторные попытки **НЕ делаются**
- ✅ Импорт продолжается для следующих ящиков

**Пример в логах:**
```
ERROR: Ошибка: Неверные данные в запросе. Проверьте правильность заполнения полей email и name.
ERROR: В поле email должен быть указан email адрес в ОСНОВНОМ (ПО УМОЛЧАНИЮ) ДОМЕНЕ организации, либо, в случае указания только alias,
ERROR: в параметре EMAIL_DOMAIN должен быть указан основной (по умолчанию) домен организации. Сейчас указан: 'company.ru'
ERROR: Общий ящик 'support@company.ru' не может быть создан - неверные данные в запросе.
```

**Решение:**
1. **Проверьте основной домен вашей организации:**
   - Откройте консоль администрирования Yandex 360 (admin.yandex.ru)
   - Перейдите в раздел "Домены"
   - Найдите домен с меткой "Основной" или "По умолчанию"

2. **Обновите параметр `EMAIL_DOMAIN` в файле `.env`:**
   ```env
   EMAIL_DOMAIN=основной-домен.ru
   ```

3. **Проверьте формат email адресов в файле `shared.csv`:**
   - При указании полного адреса: используйте основной домен
   - При указании только alias: параметр `EMAIL_DOMAIN` должен содержать основной домен

**Важно:** 
> [!WARNING]
> Общие почтовые ящики могут быть созданы **только в основном (по умолчанию) домене** организации Yandex 360. 
> Даже если у вас несколько доменов, для создания общих ящиков используйте именно тот домен, который помечен как "Основной" в консоли администрирования.

## Требования

- Действующий OAuth токен с правами на создание общих ящиков
- Доступ к API Yandex 360
- Настроенный `EMAIL_DOMAIN` в файле `.env` (если используются алиасы без домена)
- Опционально: настроенный `SHARED_MAILBOXES_FILE` в файле `.env` (по умолчанию `shared.csv`)

## Режим DRY_RUN

При включенном режиме `DRY_RUN=true` в файле `.env`:
- Создание ящиков **не выполняется**
- Выполняется только валидация файла
- В логе отображаются сообщения `[DRY RUN]`

## Логирование

Все операции логируются в файл `add_users.log`:

- DEBUG уровень: детали API запросов
- INFO уровень: прогресс импорта
- ERROR уровень: ошибки валидации и API

## Связанные функции

- `validate_shared_mailbox_email()` - валидация email адресов
- `read_shared_mailboxes_file()` - чтение и валидация файла
- `create_shared_mailbox_by_api()` - создание ящика через API
- `import_shared_mailboxes_from_file()` - основная функция импорта
- `import_shared_mailboxes_prompt()` - интерактивное меню

## Дополнительная информация

Подробнее о создании общих ящиков через API Yandex 360:
https://yandex.ru/dev/api360/doc/ru/ref/MailboxService/MailboxService_CreateShared

