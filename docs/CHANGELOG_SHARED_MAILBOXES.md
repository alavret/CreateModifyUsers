# Changelog - Функция импорта общих ящиков

## Дата: 15 октября 2025

## Добавленная функциональность

### Новые функции в add_users.py

1. **`validate_shared_mailbox_email(settings, email)`** (строка 1928)
   - Валидация email адресов для общих ящиков
   - Поддержка форматов: `alias` и `alias@domain.com`
   - Проверка на допустимые символы и структуру

2. **`read_shared_mailboxes_file(settings, file_path)`** (строка 1976)
   - Чтение файла shared.csv
   - Валидация данных построчно
   - Проверка на дубликаты email
   - Проверка структуры файла (заголовки, количество колонок)
   - Пропуск строк-комментариев (начинающихся с #)

3. **`create_shared_mailbox_by_api(settings, mailbox)`** (строка 2084)
   - Создание общего ящика через API Yandex 360
   - Endpoint: `POST /directory/v1/org/{orgId}/mail/shared`
   - Поддержка режима DRY_RUN
   - Автоматические повторные попытки при ошибках
   - Автоматическое добавление домена для алиасов

4. **`import_shared_mailboxes_from_file(settings, file_path)`** (строка 2157)
   - Основная функция импорта
   - Двухфазный процесс: валидация + создание
   - Подробное логирование процесса
   - Статистика результатов

5. **`import_shared_mailboxes_prompt(settings)`** (строка 2225)
   - Интерактивная функция для меню
   - Отображение справки по формату файла
   - Подтверждение перед импортом

### Изменения в меню

- Добавлен пункт **"7. Импортировать общие ящики из файла"** в главное меню (строка 3604)
- Обновлена подсказка с выбором опций (0-7 вместо 0-6)

## Созданные файлы

1. **`shared.csv`** - Пример файла для импорта общих ящиков
   - Формат: `email;name;description`
   - Содержит примеры разных форматов email
   - Демонстрирует использование комментариев

2. **`SHARED_MAILBOXES_README.md`** - Подробная документация
   - Описание формата файла
   - Процесс валидации
   - Обработка ошибок
   - API метод
   - Примеры использования

3. **`SHARED_MAILBOXES_QUICK_START.md`** - Краткое руководство
   - Быстрый старт в 3 шага
   - Примеры форматов email
   - Устранение типичных ошибок
   - Тестовый режим

4. **`CHANGELOG_SHARED_MAILBOXES.md`** - Этот файл

## Обновленные файлы

1. **`README.md`**
   - Добавлен раздел "Управление общими ящиками"
   - Обновлена нумерация разделов
   - Добавлено описание опции 7 в интерактивном меню
   - Добавлены ссылки на новую документацию

## Особенности реализации

### Валидация данных

- **Формат email**: проверка на соответствие pattern `alias` или `alias@domain.com`
- **Дубликаты**: проверка уникальности email (case-insensitive)
- **Обязательные поля**: name не может быть пустым
- **Структура файла**: проверка заголовков и количества колонок

### Обработка ошибок

- **При наличии ошибок валидации**: импорт полностью блокируется
- **Вывод всех ошибок**: показываются номера строк и описание проблем
- **API ошибки**: до 3 автоматических повторных попыток
- **Логирование**: все операции записываются в add_users.log

### Безопасность

- **DRY_RUN режим**: тестирование без реального создания ящиков
- **Валидация перед отправкой**: никакие запросы не отправляются при ошибках
- **Маскировка токенов**: OAuth токены маскируются в логах

## API Integration

### Endpoint
```
POST https://api360.yandex.net/directory/v1/org/{orgId}/mail/shared
```

### Тело запроса
```json
{
  "email": "support@company.com",
  "name": "Support Team",
  "description": "Общий ящик службы поддержки"
}
```

### Коды ответа
- `200 OK` / `201 CREATED` - успешное создание
- `400 Bad Request` - некорректные данные
- `401 Unauthorized` - проблемы с авторизацией
- `409 Conflict` - ящик уже существует

## Использование

### Через меню
```bash
python3 add_users.py
# Выбрать опцию 7
# Ввести путь к файлу (или нажать Enter для shared.csv)
# Подтвердить импорт
```

### Программный вызов
```python
from add_users import get_settings, import_shared_mailboxes_from_file

settings = get_settings()
success = import_shared_mailboxes_from_file(settings, "shared.csv")
```

## Формат файла shared.csv

```csv
email;name;description
support;Support Team;Общий ящик службы поддержки
info;Information;Информационный ящик
sales@company.com;Sales;Ящик продаж
# hr;HR Department;Комментарий - будет пропущен
```

## Требования

- OAuth токен с правами на создание общих ящиков
- Настроенный EMAIL_DOMAIN в .env (если используются алиасы)
- Доступ к API Yandex 360

## Совместимость

- ✅ Совместимо с существующим кодом
- ✅ Не ломает существующую функциональность
- ✅ Использует те же настройки из .env
- ✅ Следует стилю кодирования проекта
- ✅ Интегрировано с системой логирования

## Тестирование

Для тестирования без реального создания ящиков:

1. Установите в `.env`:
   ```
   DRY_RUN=true
   ```

2. Запустите импорт

3. Проверьте логи - должны быть пометки `[DRY RUN]`

## Производительность

- **Задержка между запросами**: 0.5 секунды (SLEEP_TIME_BETWEEN_API_CALLS)
- **Повторные попытки**: до 3 раз с экспоненциальной задержкой
- **Обработка больших файлов**: файл читается построчно (эффективная память)

## Логи

Все операции логируются в `add_users.log`:

```
2025-10-15 12:00:00.123 INFO: Импорт общих ящиков из файла shared.csv
2025-10-15 12:00:00.234 INFO: Фаза 1: Чтение и валидация файла
2025-10-15 12:00:00.345 INFO: Файл успешно прочитан. Найдено 3 общих ящиков для создания.
2025-10-15 12:00:00.456 INFO: Фаза 2: Создание общих ящиков
2025-10-15 12:00:01.567 INFO: Успех - общий ящик 'support@domain.com' ('Support Team') создан успешно.
...
2025-10-15 12:00:05.678 INFO: Всего обработано: 3
2025-10-15 12:00:05.789 INFO: Успешно создано: 3
2025-10-15 12:00:05.890 INFO: Ошибок: 0
```

## Известные ограничения

1. **Формат файла**: только CSV с разделителем `;`
2. **Кодировка**: только UTF-8
3. **Email validation**: не проверяет существование домена
4. **API лимиты**: зависят от ограничений Yandex 360

## Планы на будущее

- [ ] Поддержка обновления существующих общих ящиков
- [ ] Массовое удаление общих ящиков
- [ ] Экспорт списка общих ящиков в CSV
- [ ] Управление правами доступа к общим ящикам
- [ ] Интеграция с группами пользователей

## Автор

Разработано для проекта CreateModifyUsers
Дата: 15 октября 2025

