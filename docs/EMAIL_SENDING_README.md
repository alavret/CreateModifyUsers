# Руководство по настройке отправки Email

## Описание функционала

Скрипт `add_users.py` поддерживает автоматическую отправку приветственных email-сообщений новым пользователям после их создания в Yandex 360. Письма отправляются по адресу, указанному в поле `personal_email` во входном CSV-файле.

## Компоненты системы

1. **SMTP отправка** - отправка через защищенное соединение SSL (порт 465)
2. **HTML шаблон** - файл `email_template.html` с персонализацией
3. **Конфигурация** - параметры SMTP в файле `.env`

## Настройка SMTP

### 1. Параметры в файле .env

Добавьте следующие параметры в ваш файл `.env`:

```bash
# Включить отправку приветственных писем (true/false)
SEND_WELCOME_EMAIL=true

# SMTP сервер
SMTP_SERVER=smtp.gmail.com

# SMTP порт (465 для SSL)
SMTP_PORT=465

# Логин для аутентификации
SMTP_LOGIN=your_email@gmail.com

# Пароль приложения
SMTP_PASSWORD=your_app_password_here

# Email отправителя (опционально, по умолчанию = SMTP_LOGIN)
SMTP_FROM_EMAIL=noreply@yourcompany.com

# Домен для email адресов пользователей
EMAIL_DOMAIN=yourcompany.ru
```

### 2. Настройка для популярных провайдеров

#### Gmail

1. Включите двухфакторную аутентификацию в вашем Google аккаунте
2. Создайте "Пароль приложения":
   - Перейдите на https://myaccount.google.com/security
   - Выберите "Двухэтапная аутентификация"
   - Прокрутите вниз до "Пароли приложений"
   - Создайте новый пароль приложения
   - Используйте этот пароль в параметре `SMTP_PASSWORD`

**Параметры:**
```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=465
SMTP_LOGIN=your_email@gmail.com
SMTP_PASSWORD=your_16_character_app_password
```

#### Yandex

1. Включите "Пароли приложений" в настройках безопасности:
   - Перейдите на https://passport.yandex.ru/profile
   - Выберите "Безопасность"
   - Включите "Пароли приложений"
   - Создайте новый пароль для почтовой программы
   - Используйте этот пароль в `SMTP_PASSWORD`

**Параметры:**
```bash
SMTP_SERVER=smtp.yandex.ru
SMTP_PORT=465
SMTP_LOGIN=your_email@yandex.ru
SMTP_PASSWORD=your_app_password
```

#### Mail.ru

**Параметры:**
```bash
SMTP_SERVER=smtp.mail.ru
SMTP_PORT=465
SMTP_LOGIN=your_email@mail.ru
SMTP_PASSWORD=your_password
```

#### Outlook/Hotmail

**Параметры:**
```bash
SMTP_SERVER=smtp-mail.outlook.com
SMTP_PORT=587
SMTP_LOGIN=your_email@outlook.com
SMTP_PASSWORD=your_password
```

*Примечание:* Outlook использует STARTTLS на порту 587, а не SSL на порту 465. Для его использования потребуется модификация кода.

## Шаблон Email

Файл `email_template.html` содержит HTML-шаблон письма с поддержкой подстановки переменных.

### Доступные переменные для подстановки:

- `{{first_name}}` - Имя пользователя
- `{{middle_name}}` - Отчество
- `{{last_name}}` - Фамилия
- `{{login}}` - Логин пользователя
- `{{password}}` - Временный пароль
- `{{domain}}` - Домен из параметра EMAIL_DOMAIN
- `{{position}}` - Должность
- `{{department}}` - Название подразделения
- `{{year}}` - Текущий год

### Условные блоки:

Шаблон поддерживает простые условные конструкции:

```html
{{#if password_change_required}}
  Текст, который отобразится, если требуется смена пароля
{{else}}
  Альтернативный текст
{{/if}}

{{#if position}}
  Текст, который отобразится, если указана должность
{{/if}}
```

### Кастомизация шаблона

Вы можете полностью изменить дизайн письма, редактируя файл `email_template.html`. При этом сохраняйте переменные подстановки в формате `{{variable_name}}`.

## Структура CSV файла

Для отправки email необходимо указать поле `personal_email` в CSV файле:

```csv
login;password;password_change_required;first_name;last_name;middle_name;position;gender;birthday;language;work_phone;mobile_phone;personal_email;department
ivanov;TempPass123!;true;Иван;Иванов;Иванович;Менеджер;male;1990-01-15;ru;;+79991234567;ivan@example.com;1
```

**Важно:** Если поле `personal_email` не заполнено, письмо не будет отправлено, но пользователь будет создан.

## Логирование

Все действия по отправке email логируются в файл `add_users.log`:

- **INFO**: Успешная отправка письма
- **WARNING**: Отсутствует personal_email для пользователя
- **ERROR**: Ошибки при отправке (аутентификация, подключение, шаблон)
- **DEBUG**: Детальная информация о процессе отправки

## Безопасность

### Рекомендации:

1. **Используйте пароли приложений**, а не основной пароль от email
2. **Не храните `.env` в системе контроля версий** - добавьте в `.gitignore`
3. **Ограничьте права доступа** к файлу `.env`: `chmod 600 .env`
4. **Используйте отдельный email аккаунт** для отправки служебных писем
5. **Регулярно меняйте пароли** приложений

### Что НЕ делать:

- ❌ Не используйте личный email для массовой рассылки
- ❌ Не передавайте пароли в параметрах командной строки
- ❌ Не коммитьте `.env` в Git
- ❌ Не используйте один пароль для разных сервисов

## Тестирование

### Тестовая отправка

Для тестирования отправки email без создания пользователей используйте режим DRY_RUN:

```bash
# В файле .env
DRY_RUN=true
SEND_WELCOME_EMAIL=true
```

В этом режиме скрипт проверит корректность данных, но не создаст пользователей и не отправит письма.

### Проверка настроек SMTP

Вы можете проверить настройки SMTP, запустив простой тест:

```python
import smtplib
from email.mime.text import MIMEText

try:
    with smtplib.SMTP_SSL('smtp.gmail.com', 465, timeout=10) as server:
        server.login('your_email@gmail.com', 'your_app_password')
        print("✓ Подключение и аутентификация успешны!")
except Exception as e:
    print(f"✗ Ошибка: {e}")
```

## Устранение проблем

### Ошибка аутентификации

```
ERROR: Ошибка аутентификации SMTP: (535, b'5.7.8 Username and Password not accepted')
```

**Решение:**
- Проверьте правильность логина и пароля
- Используйте пароль приложения, а не основной пароль
- Убедитесь, что включена двухфакторная аутентификация

### Ошибка подключения

```
ERROR: Неожиданная ошибка при отправке email: TimeoutError
```

**Решение:**
- Проверьте правильность SMTP_SERVER и SMTP_PORT
- Убедитесь, что firewall не блокирует порт 465
- Проверьте интернет-соединение

### Шаблон не найден

```
ERROR: Файл шаблона email email_template.html не найден!
```

**Решение:**
- Убедитесь, что файл `email_template.html` находится в той же директории, что и `add_users.py`
- Проверьте права доступа к файлу

### Письмо не отправляется

**Проверьте:**
1. `SEND_WELCOME_EMAIL=true` в `.env`
2. Заполнено поле `personal_email` в CSV файле
3. Email адрес в `personal_email` корректен
4. Логи в `add_users.log` для деталей ошибки

## Производительность

- Отправка одного email занимает ~1-3 секунды
- При создании большого количества пользователей это может занять время
- Таймаут подключения: 10 секунд (константа `SMTP_TIMEOUT`)
- Отправка происходит последовательно после создания каждого пользователя

## Примеры использования

### Пример 1: Отправка только для некоторых пользователей

В CSV файле укажите `personal_email` только для тех пользователей, которым нужно отправить письмо:

```csv
login;...;personal_email;...
user1;...;user1@example.com;...  ← получит письмо
user2;...;;...                    ← НЕ получит письмо (пустое поле)
```

### Пример 2: Изменение темы письма

Отредактируйте функцию `send_welcome_email` в файле `add_users.py`:

```python
# Было:
subject = f"Добро пожаловать в Yandex 360! Ваш логин: {user_data.get('login', '')}"

# Стало:
subject = "Ваш аккаунт в корпоративной системе создан"
```

## Дополнительная информация

### Формат писем

Письма отправляются в формате **HTML** с использованием кодировки **UTF-8**. Это обеспечивает:
- Корректное отображение кириллицы
- Поддержку форматирования и стилей
- Адаптивность для мобильных устройств

### Альтернативные варианты

Если у вас нет возможности использовать SMTP, рассмотрите альтернативы:
- Использование облачных сервисов email (SendGrid, Mailgun, AWS SES)
- Интеграция с корпоративной системой рассылки
- Экспорт данных для ручной отправки через почтовый клиент

## Поддержка

При возникновении проблем:
1. Проверьте логи в файле `add_users.log`
2. Убедитесь в корректности настроек в `.env`
3. Проверьте доступность SMTP сервера
4. Обратитесь к документации вашего email провайдера


