# Тестовые сценарии для импорта общих ящиков

## Сценарий 1: Успешный импорт корректного файла

**Цель**: Проверить успешное создание общих ящиков из корректного файла

**Тестовый файл** `test1.csv`:
```csv
email;name;description
support;Support Team;Служба поддержки
info;Information;Информационный отдел
sales;Sales;Отдел продаж
```

**Ожидаемый результат**:
- ✅ Все 3 ящика созданы успешно
- ✅ Email адреса: support@domain.com, info@domain.com, sales@domain.com
- ✅ Статистика: Успешно создано: 3, Ошибок: 0

**Команда**:
```bash
python3 add_users.py
# Выбрать 7
# Ввести: test1.csv
# Подтвердить: да
```

---

## Сценарий 2: Импорт с полным email адресом

**Цель**: Проверить поддержку полных email адресов

**Тестовый файл** `test2.csv`:
```csv
email;name;description
support@company.ru;Support;Поддержка
info@company.ru;Info;Информация
sales@company.com;Sales;Продажи
```

**Ожидаемый результат**:
- ✅ Все 3 ящика созданы с указанными доменами
- ✅ Email адреса остались без изменений
- ✅ Статистика: Успешно создано: 3, Ошибок: 0

---

## Сценарий 3: Файл с комментариями

**Цель**: Проверить корректную обработку комментариев

**Тестовый файл** `test3.csv`:
```csv
email;name;description
support;Support;Активный ящик
# test;Test;Этот ящик пропущен
info;Information;Активный ящик
# hr;HR;Тоже пропущен
sales;Sales;Активный ящик
```

**Ожидаемый результат**:
- ✅ Созданы только 3 ящика (без комментариев)
- ✅ В логах: "Строка X: пропущена (комментарий)"
- ✅ Статистика: Успешно создано: 3, Ошибок: 0

---

## Сценарий 4: Дублирующиеся email адреса

**Цель**: Проверить обнаружение дубликатов

**Тестовый файл** `test4.csv`:
```csv
email;name;description
support;Support Team;Первый ящик
info;Information;Второй ящик
support;Support Duplicate;Дубликат!
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Ошибка: "Строка 4: Дублирующийся email "support" (уже встречался в строке 2)"
- ❌ Ящики не созданы

---

## Сценарий 5: Некорректный формат email

**Цель**: Проверить валидацию email адресов

**Тестовый файл** `test5.csv`:
```csv
email;name;description
support;Support;Корректный
test@;Test;Некорректный - нет домена
@domain.com;Info;Некорректный - нет локальной части
-test;Test;Некорректный - начинается с дефиса
test.;Test;Некорректный - заканчивается точкой
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Список ошибок:
  - Строка 3: Некорректный email "test@": Домен email адреса не может быть пустым
  - Строка 4: Некорректный email "@domain.com": Локальная часть email адреса не может быть пустой
  - Строка 5: Некорректный email "-test": Алиас должен начинаться и заканчиваться буквой или цифрой
  - Строка 6: Некорректный email "test.": Алиас должен начинаться и заканчиваться буквой или цифрой

---

## Сценарий 6: Пустое обязательное поле (name)

**Цель**: Проверить валидацию обязательных полей

**Тестовый файл** `test6.csv`:
```csv
email;name;description
support;;Описание без имени
info;Information;Корректный
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Ошибка: "Строка 2: Поле "name" не может быть пустым для email "support""

---

## Сценарий 7: Неверное количество колонок

**Цель**: Проверить валидацию структуры файла

**Тестовый файл** `test7.csv`:
```csv
email;name;description
support;Support
info;Information;Description;Extra Column
sales;Sales;Description
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Ошибки:
  - Строка 2: Неверное количество колонок (ожидается 3, получено 2)
  - Строка 3: Неверное количество колонок (ожидается 3, получено 4)

---

## Сценарий 8: Неверные заголовки

**Цель**: Проверить валидацию заголовков файла

**Тестовый файл** `test8.csv`:
```csv
email;title;info
support;Support;Description
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Ошибка: "Строка 1: Неверные заголовки. Ожидаются: email;name;description, получены: email;title;info"

---

## Сценарий 9: Пустой файл

**Цель**: Проверить обработку пустого файла

**Тестовый файл** `test9.csv`:
```csv
```

**Ожидаемый результат**:
- ❌ Импорт НЕ выполнен
- ❌ Ошибка: "Файл пустой"

---

## Сценарий 10: Только заголовок, нет данных

**Цель**: Проверить обработку файла без данных

**Тестовый файл** `test10.csv`:
```csv
email;name;description
```

**Ожидаемый результат**:
- ⚠️ Импорт завершен
- ⚠️ Предупреждение: "В файле нет данных для импорта (все строки пропущены или файл пустой)"
- ⚠️ Ящики не созданы

---

## Сценарий 11: Только комментарии

**Цель**: Проверить файл состоящий только из комментариев

**Тестовый файл** `test11.csv`:
```csv
email;name;description
# support;Support;Комментарий 1
# info;Info;Комментарий 2
# sales;Sales;Комментарий 3
```

**Ожидаемый результат**:
- ⚠️ Импорт завершен
- ⚠️ Предупреждение: "В файле нет данных для импорта (все строки пропущены или файл пустой)"
- ⚠️ Ящики не созданы

---

## Сценарий 12: DRY_RUN режим

**Цель**: Проверить режим тестового прогона

**Настройки** `.env`:
```
DRY_RUN=true
```

**Тестовый файл** `test12.csv`:
```csv
email;name;description
support;Support;Test
info;Info;Test
```

**Ожидаемый результат**:
- ✅ Валидация выполнена успешно
- ✅ В логах: "[DRY RUN] Пропущено создание общего ящика..."
- ✅ Реальные ящики НЕ созданы
- ✅ Статистика: Успешно создано: 2 (в режиме DRY_RUN)

---

## Сценарий 13: Смешанный формат email

**Цель**: Проверить обработку разных форматов в одном файле

**Тестовый файл** `test13.csv`:
```csv
email;name;description
support;Support;Только алиас
info@company.ru;Information;Полный email
sales;Sales;Только алиас
hr@company.com;HR;Полный email с другим доменом
```

**Ожидаемый результат**:
- ✅ Все 4 ящика созданы
- ✅ Email адреса:
  - support@domain.com (добавлен домен из EMAIL_DOMAIN)
  - info@company.ru (оставлен как есть)
  - sales@domain.com (добавлен домен из EMAIL_DOMAIN)
  - hr@company.com (оставлен как есть)

---

## Сценарий 14: Специальные символы в имени и описании

**Цель**: Проверить поддержку Unicode и спецсимволов

**Тестовый файл** `test14.csv`:
```csv
email;name;description
support;Поддержка 24/7;Круглосуточная служба поддержки
info;Информация & Справки;Вопросы и ответы
sales;Отдел продаж (ГО);Главный офис - отдел продаж
```

**Ожидаемый результат**:
- ✅ Все 3 ящика созданы
- ✅ Имена и описания сохранены корректно с кириллицей и спецсимволами

---

## Сценарий 15: Большой файл (100+ ящиков)

**Цель**: Проверить производительность и стабильность

**Тестовый файл**: Сгенерировать файл с 100 записями

**Ожидаемый результат**:
- ✅ Все ящики созданы последовательно
- ✅ Задержка 0.5 сек между запросами соблюдена
- ✅ Все операции залогированы
- ✅ Статистика корректна

---

## Сценарий 16: API ошибка (несуществующий домен)

**Цель**: Проверить обработку ошибок API

**Условия**: Указать email с несуществующим доменом (если API это проверяет)

**Ожидаемый результат**:
- ❌ API вернет ошибку
- ❌ До 3 повторных попыток
- ❌ Ошибка залогирована с кодом и сообщением
- ❌ Статистика: Ошибок: 1

---

## Сценарий 17: Отсутствие прав у токена

**Цель**: Проверить обработку ошибок авторизации

**Условия**: Использовать токен без прав на создание общих ящиков

**Ожидаемый результат**:
- ❌ API вернет 401 или 403
- ❌ Ошибка залогирована
- ❌ Импорт остановлен

---

## Сценарий 18: Прерывание импорта (Ctrl+C)

**Цель**: Проверить корректное завершение при прерывании

**Действия**:
1. Начать импорт большого файла
2. Нажать Ctrl+C во время создания ящиков

**Ожидаемый результат**:
- ✅ Программа корректно завершается
- ✅ Уже созданные ящики остаются в системе
- ✅ В логе: "Ctrl+C pressed. До свидания!"

---

## Чеклист для полного тестирования

### Валидация файла
- [ ] Корректный файл
- [ ] Пустой файл
- [ ] Файл без данных (только заголовок)
- [ ] Неверные заголовки
- [ ] Неверное количество колонок
- [ ] Файл с комментариями
- [ ] Файл только с комментариями

### Валидация email
- [ ] Корректный алиас
- [ ] Корректный полный email
- [ ] Некорректный алиас (спецсимволы)
- [ ] Некорректный email (нет домена)
- [ ] Некорректный email (нет локальной части)
- [ ] Дублирующиеся email (case-insensitive)

### Валидация полей
- [ ] Пустое поле name
- [ ] Пустое поле description (допустимо)
- [ ] Unicode символы
- [ ] Спецсимволы

### API взаимодействие
- [ ] Успешное создание
- [ ] Ошибка API
- [ ] Повторные попытки
- [ ] Задержка между запросами

### Режимы работы
- [ ] Обычный режим
- [ ] DRY_RUN режим
- [ ] Прерывание Ctrl+C

### Логирование
- [ ] DEBUG уровень в файле
- [ ] INFO уровень в консоли
- [ ] Статистика результатов
- [ ] Маскировка токенов

---

## Инструкция по запуску тестов

1. **Подготовка окружения**:
   ```bash
   cd /Users/alavret/Documents/GitHub/CreateModifyUsers
   source virtenv/bin/activate  # если используется виртуальное окружение
   ```

2. **Проверка настроек** `.env`:
   ```bash
   cat .env | grep -E "(OAUTH_TOKEN|ORG_ID|EMAIL_DOMAIN)"
   ```

3. **Создание тестовых файлов**:
   ```bash
   # Создайте файлы test1.csv, test2.csv и т.д. по описанию выше
   ```

4. **Запуск теста**:
   ```bash
   python3 add_users.py
   # Выбрать 7
   # Ввести имя тестового файла
   # Подтвердить или отменить
   ```

5. **Проверка результатов**:
   ```bash
   # Проверить логи
   tail -f add_users.log
   
   # Проверить созданные ящики через API или веб-интерфейс
   ```

6. **Очистка** (удаление тестовых ящиков):
   ```bash
   # Удалить созданные тестовые ящики через веб-интерфейс Yandex 360
   # или через API (функция удаления пока не реализована)
   ```

---

## Автоматизированное тестирование

Для автоматизации тестирования можно создать Python скрипт:

```python
import subprocess
import os

test_cases = [
    ("test1.csv", True, "Успешный импорт"),
    ("test2.csv", True, "Полные email"),
    ("test4.csv", False, "Дубликаты"),
    ("test5.csv", False, "Некорректные email"),
    # ... добавить все сценарии
]

for filename, should_succeed, description in test_cases:
    print(f"\n{'='*60}")
    print(f"Тест: {description}")
    print(f"Файл: {filename}")
    print(f"{'='*60}")
    
    # Здесь код для автоматического вызова функции импорта
    # и проверки результата
```

---

## Отчет о тестировании

После выполнения всех тестов заполните таблицу:

| Сценарий | Статус | Примечания |
|----------|--------|------------|
| 1. Успешный импорт | ⬜ | |
| 2. Полные email | ⬜ | |
| 3. Комментарии | ⬜ | |
| 4. Дубликаты | ⬜ | |
| 5. Некорректные email | ⬜ | |
| 6. Пустое name | ⬜ | |
| 7. Неверное кол-во колонок | ⬜ | |
| 8. Неверные заголовки | ⬜ | |
| 9. Пустой файл | ⬜ | |
| 10. Только заголовок | ⬜ | |
| 11. Только комментарии | ⬜ | |
| 12. DRY_RUN | ⬜ | |
| 13. Смешанный формат | ⬜ | |
| 14. Спецсимволы | ⬜ | |
| 15. Большой файл | ⬜ | |
| 16. API ошибка | ⬜ | |
| 17. Ошибка авторизации | ⬜ | |
| 18. Ctrl+C | ⬜ | |

Статусы: ✅ Пройден | ❌ Не пройден | ⚠️ Частично пройден

