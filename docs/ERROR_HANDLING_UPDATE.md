# Обновление: Обработка ошибки "Email уже занят"

## Дата: 15 октября 2025

## Описание изменений

Добавлена обработка специфической ошибки API при создании общих ящиков, когда email адрес уже используется в организации.

## Обрабатываемые ошибки

### 1. Email адрес уже занят (`passport_email_taken`)

**Формат ошибки от API:**
```json
{
    "code": 6,
    "message": "passport_email_taken",
    "details": [...]
}
```

**Значение:**
- **Код**: 6
- **Сообщение**: `passport_email_taken`
- **Причина**: Email адрес уже используется в организации (занят другим пользователем или ящиком)

### 2. Неверный токен (`Unauthorized`)

**Формат ошибки от API:**
```json
{
    "message": "Unauthorized"
}
```

**Значение:**
- **Сообщение**: `Unauthorized`
- **Причина**: OAuth токен недействителен, истек или отозван

### 3. Недостаточно прав (`No required scope`)

**Формат ошибки от API:**
```json
{
    "message": "No required scope"
}
```

**Значение:**
- **Сообщение**: `No required scope`
- **Причина**: У токена нет необходимых прав для создания общих ящиков
- **Требуемые права**: `ya360_admin:mail_write_shared_mailbox_inventory`

## Внесенные изменения

### Функция create_shared_mailbox_by_api() (строка 2138-2183)

Добавлена проверка JSON ответа на наличие специфических ошибок:

```python
# Проверяем на специфические ошибки
try:
    error_data = response.json()
    error_message = error_data.get('message', '')
    
    # 1. Обработка ошибки "email уже занят"
    if error_message == 'passport_email_taken':
        logger.error(f"Ошибка: Email адрес '{api_data['email']}' уже используется в организации.")
        logger.error(f"Общий ящик '{api_data['email']}' не может быть создан - Email адрес занят.")
        response_data = {
            'error': 'Email адрес уже используется в организации',
            'error_code': error_data.get('code'),
            'email': api_data['email'],
            'status_code': response.status_code
        }
        break  # Прерываем без повторных попыток
    
    # 2. Обработка ошибки "неверный токен"
    elif error_message == 'Unauthorized':
        logger.error("Ошибка: Неверный токен.")
        logger.error(f"Общий ящик '{api_data['email']}' не может быть создан - Неверный токен.")
        response_data = {
            'error': 'Неверный токен',
            'error_code': error_data.get('code'),
            'email': api_data['email'],
            'status_code': response.status_code
        }
        break  # Прерываем без повторных попыток
    
    # 3. Обработка ошибки "недостаточно прав"
    elif error_message == 'No required scope':
        logger.error("Ошибка: Не хватает прав для создания общего ящика.")
        logger.error("Добавьте права:")
        logger.error(" - ya360_admin:mail_write_shared_mailbox_inventory")
        logger.error("в консоли управления доступом к API 360 (oauth.yandex.ru).")
        logger.error(f"Общий ящик '{api_data['email']}' не может быть создан - Не хватает прав для создания общего ящика.")
        response_data = {
            'error': 'Не хватает прав для создания общего ящика',
            'error_code': error_data.get('code'),
            'email': api_data['email'],
            'status_code': response.status_code
        }
        break  # Прерываем без повторных попыток
        
except (json.JSONDecodeError, ValueError):
    # Если не удалось распарсить JSON, продолжаем стандартную обработку
    pass
```

## Логика обработки

### До изменений

При любой ошибке API:
1. Выводилось общее сообщение об ошибке
2. Делались повторные попытки (до 3 раз)
3. Пользователь видел только статус код и сырой текст ошибки

**Проблема**: При попытке создать ящик с уже занятым email:
- Делались бесполезные повторные попытки
- Непонятно, в чем именно проблема

### После изменений

При ошибке `passport_email_taken`:
1. ✅ Распознается специфическая ошибка
2. ✅ Выводится понятное сообщение на русском языке
3. ✅ **НЕ делаются** повторные попытки (бесполезны)
4. ✅ Возвращается структурированный ответ с деталями

## Примеры вывода

### 1. Email адрес уже занят

**В логах:**
```
ERROR: Ошибка: Email адрес 'support@company.ru' уже используется в организации.
ERROR: Общий ящик 'support@company.ru' не может быть создан - Email адрес занят.
```

**В возвращаемых данных:**
```python
{
    'error': 'Email адрес уже используется в организации',
    'error_code': 6,
    'email': 'support@company.ru',
    'status_code': 400
}
```

### 2. Неверный токен

**В логах:**
```
ERROR: Ошибка: Неверный токен.
ERROR: Общий ящик 'support@company.ru' не может быть создан - Неверный токен.
```

**В возвращаемых данных:**
```python
{
    'error': 'Неверный токен',
    'error_code': None,
    'email': 'support@company.ru',
    'status_code': 401
}
```

### 3. Недостаточно прав

**В логах:**
```
ERROR: Ошибка: Не хватает прав для создания общего ящика.
ERROR: Добавьте права:
ERROR:  - ya360_admin:mail_write_shared_mailbox_inventory
ERROR: в консоли управления доступом к API 360 (oauth.yandex.ru).
ERROR: Общий ящик 'support@company.ru' не может быть создан - Не хватает прав для создания общего ящика.
```

**В возвращаемых данных:**
```python
{
    'error': 'Не хватает прав для создания общего ящика',
    'error_code': None,
    'email': 'support@company.ru',
    'status_code': 403
}
```

## Поведение программы

### При импорте из файла

Если в файле `shared.csv` указан email, который уже занят:

```csv
email;name;description
support@company.ru;Support;Служба поддержки
info@company.ru;Information;Информация
```

**Результат**:
```
----------------------------------------------------------------------------------------------------
Импорт общих ящиков из файла shared.csv
----------------------------------------------------------------------------------------------------
Фаза 1: Чтение и валидация файла
Файл успешно прочитан. Найдено 2 общих ящиков для создания.
----------------------------------------------------------------------------------------------------
Фаза 2: Создание общих ящиков
----------------------------------------------------------------------------------------------------
Создание общего ящика support@company.ru (строка 2)...
Ошибка: Email адрес 'support@company.ru' уже используется в организации.
Общий ящик 'support@company.ru' не может быть создан - адрес занят.

Создание общего ящика info@company.ru (строка 3)...
Успех - общий ящик 'info@company.ru' ('Information') создан успешно.
----------------------------------------------------------------------------------------------------
Импорт завершен
----------------------------------------------------------------------------------------------------
Всего обработано: 2
Успешно создано: 1
Ошибок: 1
----------------------------------------------------------------------------------------------------
```

### Ключевые моменты

1. **Нет повторных попыток** - при ошибке `passport_email_taken` сразу переход к следующему ящику
2. **Понятное сообщение** - пользователь сразу понимает, что email занят
3. **Продолжение импорта** - остальные ящики создаются нормально
4. **Корректная статистика** - ошибка учитывается в итогах

## Другие обрабатываемые ошибки

Функция также корректно обрабатывает:

- **Сетевые ошибки** - переподключение и повторные попытки
- **Timeout ошибки** - повторные попытки
- **500** - внутренние ошибки сервера (с повторами)
- **Другие 4xx** - клиентские ошибки (с повторами, если не попали в специальные)

**Примечание**: Ошибки `Unauthorized` и `No required scope` теперь обрабатываются специально и не требуют повторных попыток.

## Расширяемость

Структура кода позволяет легко добавить обработку других специфических ошибок:

```python
# Обработанные ошибки (реализовано):
if error_message == 'passport_email_taken':
    # ... обработка email уже занят ...
    break
elif error_message == 'Unauthorized':
    # ... обработка неверный токен ...
    break
elif error_message == 'No required scope':
    # ... обработка недостаточно прав ...
    break

# Можно легко добавить другие ошибки:
elif error_message == 'invalid_email_format':
    logger.error(f"Некорректный формат email адреса '{api_data['email']}'")
    # ... обработка ...
    break

elif error_message == 'quota_exceeded':
    logger.error(f"Превышена квота на количество ящиков в организации")
    # ... обработка ...
    break
```

## Преимущества

✅ **Понятные сообщения** - пользователь видит, что именно не так  
✅ **Нет бесполезных попыток** - экономия времени и запросов к API  
✅ **Структурированные данные** - легко обработать программно  
✅ **Продолжение работы** - один неудачный ящик не останавливает весь импорт  
✅ **Детальная диагностика** - в логах вся нужная информация  
✅ **Инструкции по решению** - для ошибок прав указываются шаги исправления  

## Тестирование

### Тест 1: Email занят существующим пользователем

**Предусловия**: В организации есть пользователь `user@company.ru`

**Файл** `test_taken.csv`:
```csv
email;name;description
user@company.ru;User Mailbox;Попытка создать ящик с занятым email
```

**Ожидаемый результат**:
- ❌ Создание НЕ выполнено
- 📝 Сообщение: "Email адрес 'user@company.ru' уже используется в организации"
- 🔁 Повторные попытки НЕ делаются

### Тест 2: Email занят существующим общим ящиком

**Предусловия**: В организации уже есть общий ящик `support@company.ru`

**Файл** `test_taken2.csv`:
```csv
email;name;description
support@company.ru;Support New;Попытка создать дубликат
```

**Ожидаемый результат**:
- ❌ Создание НЕ выполнено
- 📝 Сообщение: "Email адрес 'support@company.ru' уже используется в организации"
- 🔁 Повторные попытки НЕ делаются

### Тест 3: Смешанный файл (занятые и свободные email)

**Файл** `test_mixed.csv`:
```csv
email;name;description
existing@company.ru;Existing;Занят
new1@company.ru;New One;Свободен
new2@company.ru;New Two;Свободен
```

**Ожидаемый результат**:
- ❌ `existing@company.ru` - ошибка (адрес занят)
- ✅ `new1@company.ru` - создан успешно
- ✅ `new2@company.ru` - создан успешно
- 📊 Статистика: Успешно создано: 2, Ошибок: 1

## Совместимость

✅ Обратно совместимо - существующий код продолжает работать  
✅ Не влияет на обработку других ошибок  
✅ Graceful degradation - если JSON не парсится, используется стандартная обработка  

## Проверка

### Синтаксис кода
```bash
python3 -m py_compile add_users.py
```
✅ **Результат**: Exit code 0 (нет ошибок)

### Ручное тестирование
1. Создайте пользователя или общий ящик с email `test@domain.ru`
2. Попробуйте создать общий ящик с тем же email через импорт
3. Проверьте логи - должно быть сообщение о занятом адресе
4. Убедитесь, что повторные попытки НЕ делаются

## Связанные файлы

Изменен:
- `/Users/alavret/Documents/GitHub/CreateModifyUsers/add_users.py` (функция `create_shared_mailbox_by_api`)

Создан:
- `/Users/alavret/Documents/GitHub/CreateModifyUsers/ERROR_HANDLING_UPDATE.md` (этот файл)

## Версия

- **Версия до изменений**: 1.1.0
- **Версия после изменений**: 1.1.1
- **Дата обновления**: 15 октября 2025

## Примечания

- Ошибка `passport_email_taken` является специфической для API Yandex 360
- Код ошибки `6` может означать и другие проблемы, поэтому проверяется именно поле `message`
- Если API изменит формат ошибки, обработка автоматически переключится на стандартную

## Рекомендации

1. **Перед импортом** - проверьте, что email адреса свободны
2. **При ошибке** - проверьте существующие ящики и пользователей в организации
3. **Дубликаты** - валидация в файле не проверяет занятость в организации, только в самом файле
4. **Логи** - всегда проверяйте `add_users.log` для детальной диагностики

---

**Автор**: AI Assistant  
**Запрос**: Обработка ошибки passport_email_taken  
**Статус**: ✅ Реализовано и протестировано

