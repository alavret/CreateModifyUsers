# Добавление пользователей в Yandex 360

## Обзор

Скрипт `add_users.py` предназначен для добавления новых пользователей в Yandex 360 через API. Он читает данные пользователей из CSV-файла (`users.csv`), проверяет их на корректность и отправляет запросы на создание пользователей в Yandex 360. Скрипт поддерживает режим "сухого прогона" (`DRY_RUN`) для тестирования без фактического создания пользователей, а также режим анализа файла для проверки данных без их отправки.

## Функциональность

Скрипт `add_users.py` предоставляет комплексное решение для управления пользователями в Yandex 360 с расширенными возможностями:

### Основные возможности

1. **Управление пользователями**:
   - Создание новых пользователей из CSV-файла
   - Просмотр атрибутов существующих пользователей
   - Экспорт всех пользователей организации
   - Поиск пользователей по различным критериям

2. **Управление подразделениями**:
   - Поиск подразделений по ID, названию или алиасу
   - Создание иерархии подразделений
   - Автоматическое создание промежуточных подразделений
   - Просмотр структуры организации

3. **Обработка данных**:
   - Чтение данных из CSV-файла с поддержкой 14 полей
   - Валидация всех типов данных (пароли, email, телефоны, даты)
   - Маскировка чувствительных данных в логах
   - Обработка ошибок с повторными попытками

### Детальная функциональность

#### 1. **Чтение и валидация данных**:
   - Загружает данные пользователей из CSV-файла, указанного в переменной `USERS_FILE`
   - Поддерживает расширенный набор полей: логин, пароль, необходимость смены пароля, имя, фамилия, отчество, должность, пол, дата рождения, язык, рабочий и мобильный телефоны, личный email, отделы
   - Проверяет обязательные поля (логин, имя, фамилия, пароль, язык, пол, необходимость смены пароля)
   - Валидирует формат логина (латинские буквы, цифры, точки, дефисы, без начального подчёркивания)
   - Проверяет имена (кириллица, первая буква заглавная, возможен дефис)
   - Проверяет номера телефонов (допустимые символы: цифры, `+`, `-`, `(`, `)`, пробелы, точки; длина 3–16 цифр)
   - Проверяет дату рождения (форматы: `DD.MM.YYYY`, `DD-MM-YYYY`, `YYYY-MM-DD` и др.; возраст 10–100 лет)
   - Проверяет язык (`ru` или `en`) и пол (`male` или `female`)
   - **Валидация паролей**: Проверяет пароли по настраиваемому регулярному выражению
   - **Валидация email**: Проверяет корректность личных email адресов

#### 2. **Создание пользователей**:
   - Отправляет POST-запросы к API Yandex 360 (`https://api360.yandex.net/directory/v1/org/{orgId}/users`) для создания пользователей
   - Формирует JSON с данными пользователя, включая контакты (рабочий и мобильный телефоны, личный email), если они указаны
   - Поддерживает до 3 повторных попыток при ошибках запроса с задержкой в 1 секунду
   - Создает подразделения при необходимости

#### 3. **Интерактивное меню**:
   - **Опция 1**: Добавление пользователей из CSV-файла
   - **Опция 2**: Анализ файла на ошибки без создания пользователей
   - **Опция 3**: Поиск подразделений по названию или алиасу
   - **Опция 4**: Просмотр атрибутов пользователя
   - **Опция 5**: Экспорт всех пользователей в файл
   - **Опция 0**: Выход из программы

#### 4. **Режимы работы**:
   - **Реальный режим**: Создание пользователей в Yandex 360
   - **Режим "сухого прогона"** (`DRY_RUN=true`): Имитация создания без изменений
   - **Режим анализа**: Проверка CSV-файла на ошибки без отправки данных

#### 5. **Логирование и безопасность**:
   - Логирует операции в консоль (уровень INFO) и в ротируемый файл `add_users.log` (уровень DEBUG)
   - Ротация файла происходит при достижении 1 МБ, сохраняется до 5 резервных копий
   - **Маскировка чувствительных данных**: Пароли и токены автоматически маскируются в логах
   - Обработка ошибок с подробным логированием

## Конфигурационные параметры

Скрипт использует следующие переменные окружения, которые можно задать в файле `.env` в каталоге скрипта или непосредственно в окружении:

| Имя параметра | Описание | Обязательный | Пример значения |
|---------------|----------|--------------|-----------------|
| `OAUTH_TOKEN` | OAuth-токен для аутентификации в API Yandex 360 | Да | `y0_AgAAAA...` |
| `ORG_ID` | Идентификатор организации в Yandex 360 (целочисленный) | Да | `123456` |
| `USERS_FILE` | Имя CSV-файла с данными пользователей | Да | `users.csv` |
| `DRY_RUN_ARG` | Режим "сухого прогона" (`true` для имитации, `false` для реального создания) | Нет (по умолчанию `false`) | `true` или `false` |
| `PASSWORD_PATTERN` | Регулярное выражение для валидации паролей | Нет | `^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};:"\\|,.<>\/?]).{10,}$` |
| `DEPS_FILE` | Файл с информацией об отделах (по умолчанию `deps.csv`) | Нет | `deps.csv` |
| `ALL_USERS_FILE` | Файл для сохранения всех пользователей (по умолчанию `all_users.csv`) | Нет | `all_users.csv` |

### Пример файла `.env`:

```env
# OAuth токен для доступа к API Yandex 360
OAUTH_TOKEN=your_oauth_token_here

# ID организации в Yandex 360
ORG_ID=your_org_id_here

# Путь к файлу с пользователями
USERS_FILE=users.csv

# Режим пробного запуска (true/false)
DRY_RUN_ARG=false

# Регулярное выражение для проверки паролей
# По умолчанию: минимум 10 символов, заглавная буква, цифра, спецсимвол
PASSWORD_PATTERN=^(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};:"\\|,.<>\/?]).{10,}$

# Файл с информацией об отделах (опционально)
DEPS_FILE=deps.csv

# Файл для сохранения всех пользователей (опционально)
ALL_USERS_FILE=all_users.csv
```

## Формат CSV-файла

CSV-файл (`users.csv`) должен содержать следующие столбцы (разделитель `;`):

| Поле | Описание | Обязательное | Пример значения |
|------|----------|--------------|-----------------|
| `login` | Логин пользователя (латинские буквы, цифры, `.`, `-`, без `@domain`) | Да | `rpop-test1` |
| `password` | Пароль пользователя (проверяется по PASSWORD_PATTERN) | Да | `$rfvBgt5^yhn` |
| `password_change_required` | Требуется ли смена пароля (`true` или `false`) | Да | `false` |
| `first_name` | Имя (кириллица, первая буква заглавная) | Да | `Александр` |
| `last_name` | Фамилия (кириллица, первая буква заглавная) | Да | `Иванов` |
| `middle_name` | Отчество (кириллица, первая буква заглавная) | Нет | `Иванович` |
| `position` | Должность | Нет | `Директор` |
| `gender` | Пол (`male` или `female`) | Нет | `male` |
| `birthday` | Дата рождения (например, `DD.MM.YYYY`) | Нет | `01.01.2009` |
| `language` | Язык интерфейса (`ru` или `en`) | Нет | `ru` |
| `work_phone` | Рабочий телефон (цифры, `+`, `-`, `(`, `)`, пробелы, точки) | Нет | `+71231231212` |
| `mobile_phone` | Мобильный телефон (цифры, `+`, `-`, `(`, `)`, пробелы, точки) | Нет | `+71231231212` |
| `personal_email` | Личный email адрес (проверяется на корректность) | Нет | `alexander.ivanov@example.com` |
| `department` | Отделы (см. варианты использования ниже) | Нет | `123` или `Главный офис\|IT отдел\|Разработка` |

> [!INFO]
> Личный email адрес записывается в виде JSON строки в атрибут `about` пользователя. Предполагается его использовать для уведомлений по почте пользователя о различных действиях с его учёткой в Я360 (в том числе, о новом пароле в случае сброса администратором)

### Варианты использования поля `department`

Поле `department` поддерживает два варианта указания подразделения:

#### Вариант 1: Указание по ID подразделения
Укажите числовое значение, которое соответствует полю `DepartmentId` для соответствующего подразделения:
```
department
123
456
789
```

#### Вариант 2: Указание иерархии подразделений
Укажите иерархию подразделений, начиная с верхнего уровня и заканчивая подразделением, где необходимо разместить пользователя. Имена подразделений разделяйте вертикальной чертой (`|`):

**Примеры:**
```
department
Главный офис|IT отдел|Разработка
Главный офис|HR отдел
Филиал Москва|Отдел продаж
```

**Поведение системы:**
- Если подразделение существует → пользователь добавляется в него
- Если подразделения нет → создается вместе со всеми промежуточными подразделениями в иерархии

**Пример создания иерархии:**
При указании `Главный офис|IT отдел|Разработка` система:
1. Проверит существование "Главный офис"
2. Если нет → создаст "Главный офис"
3. Проверит существование "IT отдел" внутри "Главный офис"
4. Если нет → создаст "IT отдел" внутри "Главный офис"
5. Проверит существование "Разработка" внутри "IT отдел"
6. Если нет → создаст "Разработка" внутри "IT отдел"
7. Добавит пользователя в "Разработка"

### Пример файла `users.csv`:

```csv
login;password;password_change_required;first_name;last_name;middle_name;position;gender;birthday;language;work_phone;mobile_phone;personal_email;department
rpop-test7;$rfvBgt5^yhn;false;Александр;Иванов;Иванович;Директор;male;01.01.2009;ru;+71231231212;+7 123 1231212;alexander.ivanov@example.com;123
rpop-test8;$rfvBgt5^yhn;true;Мария;Петрова;Петровна;Администратор;female;05.05.1990;en;+798345623;+7 (123) 123-12-12;maria.petrova@example.com;Главный офис|HR отдел
rpop-test9;$rfvBgt5^yhn;true;Павел;Сидоров;Александрович;Менеджер;male;20.06.2000;ru;+71234567890;+71231231212;pavel.sidorov@example.com;Главный офис|IT отдел|Разработка
```

## Валидация данных

### Валидация паролей

Скрипт проверяет пароли по регулярному выражению, заданному в переменной `PASSWORD_PATTERN`. По умолчанию требуется:
- Минимум 10 символов
- Хотя бы одна заглавная буква
- Хотя бы одна цифра
- Хотя бы один спецсимвол из набора: `!@#$%^&*()_+-=[]{};:"\\|,.<>/?`

### Валидация email адресов

Личные email адреса проверяются на корректность согласно стандартам RFC:
- Наличие символа `@`
- Корректный формат локальной части и домена
- Длина локальной части не более 64 символов
- Длина домена не более 253 символов
- Отсутствие последовательных точек

### Маскировка чувствительных данных

В логах автоматически маскируются:
- Пароли пользователей
- OAuth токены
- Токены доступа
- Любые поля с названием "token"
## Настройка OAuth приложения

1. Для использования приложения необходимо сгенерировать OAuth токен для аутентификации в Yandex 360 API. Токен должен содержать необходимые права для выполнения операций управления ресурсами в организации Yandex 360. Документация - [Создание приложения](https://yandex.ru/dev/id/doc/ru/register-client).

Последовательность шагов для создания токена:
* перейдите на https://oauth.yandex.ru/client/new/. Аутентифицируйтесь от имени администратора организации Yandex 360
* В предлагаемом окне выберите "Для доступа к API или отладке" и нажмите "Перейти к созданию".

<img src="images/create_app_new_1.jpg" width="600">

* заполните поля в форме создания приложения:
  - поле "Название вашего сервиса" - любое название
  - проверьте почту для связи

* добавьте разрешения для токена. Для этого в разделе "Доступ к данным" найдите и добавьте следующие разрешения:

| Название разрешения | Что можно делать |
|-------------------|------------------|
| directory:read_users | читать атрибуты пользователей |
| directory:write_users | создавать пользователей и записывать в атрибуты пользователей |
| directory:read_departments   | читать атрибуты подразделений
|directory:write_departments | создавать подразделения и записывать в атрибуты подразделений

<img src="images/create_app_new_3.jpg" width="600">

* нажмите кнопку "Создать приложение"
* закройте окно с предложением пройти верификацию через Госуслуги
* в новом окне "Мои приложения" отображаются свойства созданного приложения. Найдите раздел с ID созданного приложения и скопируйте строку из поля "ClientID":

<img src="images/app_id.jpg" width="600">

* в текстовом редакторе создайте строку вида `https://oauth.yandex.ru/authorize?response_type=token&client_id=<ID приложения>` и вставьте скопированное значение ClientID из предыдущего шага вместо `<ID приложения>`

Вставьте получившуюся ссылку в браузер и нажмите "Enter".
* в окне браузера появляется запрос на подтверждение прав токена. Подтверждение **должно выполняться с аккаунта администратора организации** (если это сделать от имени обычного пользователя, токен не получит запрашиваемые права из-за отсутствия необходимых разрешений у данного пользовательского аккаунта).
Нажмите "Войти как" и получите необходимый токен доступа.

> [!WARNING]
> Скопируйте токен и сохраните его в безопасном месте.

2. Получите ID организации в Yandex 360. Для этого перейдите в [консоль администрирования](admin.yandex.ru) и в левом нижнем углу интерфейса будет необходимый номер.

<img src="images/org_id.jpg" width="400">

3. Запишите полученные на предыдущем шаге OAuth токен и Org ID в соответствующие переменные в файле `.env` в том же каталоге, что и сами скрипты.

## Установка

1. **Установите Python**: Требуется Python 3.7 или выше.

2. **Установите зависимости**:
   
   Скрипт использует следующие Python-пакеты:

   | Пакет | Версия | Назначение |
   |-------|--------|------------|
   | `python-dotenv` | 1.1.0 | Загрузка переменных окружения из `.env` |
   | `requests` | 2.32.3 | HTTP-запросы к API Yandex 360 |
   | `certifi` | 2025.1.31 | SSL-сертификаты для безопасных соединений |
   | `charset-normalizer` | 3.4.1 | Определение кодировки текста |
   | `idna` | 3.10 | Обработка международных доменных имен |
   | `urllib3` | 2.3.0 | HTTP-клиент низкого уровня |

   **Способ 1: Установка из requirements.txt (рекомендуется)**
   ```bash
   pip install -r requirements.txt
   ```

   **Способ 2: Установка основных пакетов**
   ```bash
   pip install python-dotenv requests
   ```

   **Способ 3: Создание виртуального окружения (рекомендуется)**
   ```bash
   # Создание виртуального окружения
   python -m venv venv
   
   # Активация (Linux/macOS)
   source venv/bin/activate
   
   # Активация (Windows)
   venv\Scripts\activate
   
   # Установка зависимостей
   pip install -r requirements.txt
   ```

3. **Проверьте установку**:
   ```bash
   # Проверка версии Python
   python --version
   
   # Проверка установленных пакетов
   pip list
   
   # Проверка конкретных пакетов
   python -c "import requests, dotenv; print('Все пакеты установлены успешно')"
   ```

4. **Настройте окружение**:
   - Создайте файл `.env` в каталоге скрипта с необходимыми параметрами (см. пример выше).
   - Подготовьте CSV-файл (`users.csv`) с данными пользователей в правильном формате.
   - Убедитесь, что у вас есть действующий OAuth-токен и ID организации Yandex 360.

### Системные требования

- **Python**: 3.7 или выше
- **Операционная система**: Windows, macOS, Linux
- **Память**: минимум 512 МБ RAM
- **Дисковое пространство**: 50 МБ для установки зависимостей
- **Сеть**: доступ к интернету для работы с API Yandex 360

### Устранение проблем

**Ошибка "ModuleNotFoundError"**:
```bash
# Переустановите зависимости
pip install --upgrade -r requirements.txt
```

**Проблемы с SSL-сертификатами**:
```bash
# Обновите certifi
pip install --upgrade certifi
```

**Конфликты версий**:
```bash
# Используйте виртуальное окружение
python -m venv venv
source venv/bin/activate  # Linux/macOS
# или
venv\Scripts\activate     # Windows
pip install -r requirements.txt
```

## Запуск

1. **Подготовка**:
   - Поместите скрипт `add_users.py` и файл `users.csv` в рабочий каталог.
   - Создайте и заполните файл `.env` или задайте переменные окружения.

2. **Запуск скрипта**:
   ```bash
   python add_users.py
   ```
   Это откроет интерактивное меню.

3. **Использование меню**:
   
   После запуска скрипта откроется интерактивное меню с следующими опциями:

   | Опция | Описание | Функциональность |
   |-------|----------|------------------|
   | `1` | Добавить пользователей из файла | Создание пользователей в Yandex 360 из CSV-файла |
   | `2` | Анализировать входной файл на ошибки | Проверка CSV-файла без создания пользователей |
   | `3` | Поиск подразделения по названию или алиасу | Поиск существующих подразделений в организации |
   | `4` | Показать атрибуты пользователя | Просмотр информации о конкретном пользователе |
   | `5` | Выгрузить всех пользователей в файл | Экспорт всех пользователей организации в CSV |
   | `0` | Выход | Завершение работы программы |

   ### Подробное описание опций:

   **Опция 1: Добавление пользователей**
   - Читает данные из CSV-файла, указанного в `USERS_FILE`
   - Проверяет корректность всех данных (пароли, email, телефоны и т.д.)
   - Создает пользователей в Yandex 360 через API
   - В режиме `DRY_RUN=true` только имитирует создание
   - При обнаружении подозрительных данных запрашивает подтверждение

   **Опция 2: Анализ файла**
   - Проверяет CSV-файл на ошибки без отправки данных в API
   - Выводит подробный отчет о найденных проблемах
   - Показывает количество корректных и некорректных записей
   - Рекомендуется использовать перед реальным добавлением пользователей

   **Опция 3: Поиск подразделений**
   - Позволяет найти подразделения по ID, названию или алиасу
   - Показывает иерархию подразделений
   - Помогает определить правильные ID для поля `department`
   - Поддерживает поиск по части названия

   **Опция 4: Просмотр атрибутов пользователя**
   - Поиск пользователя по UID, никнейму, алиасу или фамилии
   - Отображение полной информации о пользователе
   - Показывает контакты, подразделения и другие атрибуты
   - Полезно для проверки существующих пользователей

   **Опция 5: Экспорт пользователей**
   - Загружает всех пользователей организации из Yandex 360
   - Сохраняет данные в файл, указанный в `ALL_USERS_FILE`
   - Включает полную информацию о пользователях и их подразделениях
   - Полезно для создания резервных копий или анализа структуры

4. **Пример работы**:
   
   **Типичный рабочий процесс:**
   
   1. **Подготовка данных:**
      - Запустите скрипт: `python add_users.py`
      - Выберите `2` для проверки `users.csv` на ошибки
      - Исправьте ошибки в файле, если они найдены
   
   2. **Проверка подразделений:**
      - Выберите `3` для поиска подразделений
      - Найдите нужные ID подразделений или проверьте иерархию
      - Обновите поле `department` в CSV-файле при необходимости
   
   3. **Добавление пользователей:**
      - Выберите `1` для добавления пользователей
      - Подтвердите продолжение, если есть подозрительные строки
      - Проверьте логи в `add_users.log` и консоль для результатов
   
   4. **Проверка результатов:**
      - Выберите `4` для просмотра атрибутов созданных пользователей
      - Выберите `5` для экспорта всех пользователей в файл
      - Проверьте корректность созданных записей

## Логирование

- **Консоль**: Сообщения уровня INFO с временными метками (например, `2023-10-01 12:00:00.123 INFO: Добавление пользователей...`).
- **Файл**: Сообщения уровня DEBUG записываются в `add_users.log`, ротация происходит при достижении 10 МБ (хранится 5 резервных копий).
- Формат логов: `%(asctime)s.%(msecs)03d %(levelname)s:\t%(message)s` с форматом даты `ГГГГ-ММ-ДД ЧЧ:ММ:СС`.
- **Безопасность**: Чувствительные данные (пароли, токены) автоматически маскируются в логах.

## Обработка ошибок

- **Ошибки конфигурации**: Отсутствие переменных `OAUTH_TOKEN`, `ORG_ID` или `USERS_FILE` приводит к завершению с ошибкой.
- **Ошибки данных**: Некорректные строки в CSV-файле (например, пустые обязательные поля, неверный формат телефона, некорректные пароли или email) логируются как ошибки, и процесс останавливается.
- **Ошибки API**: Обрабатываются с повторными попытками (до 3 раз). Ошибки аутентификации (401, 403) или неверные запросы (400) логируются.
- **Подозрительные строки**: Строки с потенциально некорректными данными (например, некириллические имена) логируются как предупреждения, и пользователь решает, продолжать ли.

## Ограничения

- **Формат логина**: Логин не должен содержать `@domain`, начинаться с `_` или включать символы, кроме латинских букв, цифр, `.`, `-`.
- **Имена**: Имена, фамилии и отчества должны быть на кириллице с заглавной первой буквой, возможен дефис.
- **Телефоны**: Длина номера 3–16 цифр, поддерживаются международные и российские форматы.
- **Дата рождения**: Возраст должен быть от 10 до 100 лет.
- **Пароли**: Должны соответствовать регулярному выражению в `PASSWORD_PATTERN`.
- **Email**: Должен соответствовать стандартам RFC для email адресов.
- **API-запросы**: Ограничены скоростью (обрабатывается код 429 с ожиданием по заголовку `Retry-After`).

## Дополнительная документация

- [EMAIL_VALIDATION_README.md](EMAIL_VALIDATION_README.md) - Подробное описание валидации email адресов
- [PASSWORD_VALIDATION_README.md](PASSWORD_VALIDATION_README.md) - Подробное описание валидации паролей
- [PASSWORD_MASKING_README.md](PASSWORD_MASKING_README.md) - Подробное описание маскировки чувствительных данных

## Лицензия

Проект распространяется под лицензией MIT. Подробности см. в файле `LICENSE`.